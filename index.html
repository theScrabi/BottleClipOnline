<!DOCTYPE html>
<html>

<head>
    <script src="stl_viewer.min.js"></script>
    <title>Bottleclip Online</title>
</head>

<body style="height:100%;">
    <div id="stl_cont" style="width:100%;height:100%;"></div>
    <div class="button-container" style="display: flex;">
        <button id="renderButton" onclick="render();" disabled>Render!!!</button>
        <button id="downloadButton" onclick="download('slice_me.stl');" disabled>Download</button>
    </div>

    <script type="module">
        import OpenSCAD from "https://openscad.cloud/openscad/openscad.js";
        import addFonts from "https://openscad.cloud/openscad/openscad.fonts.js";
        import addMCAD from "https://openscad.cloud/openscad/openscad.mcad.js";


        const scad = await OpenSCAD({ noInitialRun: true });

        const stl_viewer = new StlViewer(document.getElementById("stl_cont"));
        const downloadButton = document.getElementById('downloadButton');
        const renderButton = document.getElementById('renderButton');

        Promise.all([
            fetch('/clip/test.scad'),
            fetch('/clip/bottle-clip.scad'),
            fetch('/clip/icons/pesthoernchen.dxf'),
            fetch('/clip/write_lib/Write.scad'),
            fetch('/clip/write_lib/orbitron.dxf'),
            fetch('/clip/bottle-clip.scad')
        ]).then(async (responses) => {
            const files = [];

            responses.forEach(async (resp) => {
                const url = new URL(resp.url);
                //console.log(url.pathname);
                //console.log(resp);
                const reader = resp.body.getReader();

                try {
                    let result = '';

                    while (true) {
                        const { done, value } = await reader.read();

                        if (done) {
                            break;
                        }
                        result += new TextDecoder().decode(value);
                    }

                    files.push({ name: url.pathname.replace(new RegExp("/clip", 'g'), ""), data: result });
                } catch (error) {
                    console.error("Error reading the stream:", error);
                } finally {
                    reader.releaseLock();
                }
            });
            return files;
        }).then(async (files) => {
            scad.FS.mkdir('/icons');
            scad.FS.mkdir('/write_lib');
            console.log(files);
            files.forEach(async (file) => {
                scad.FS.writeFile(file.name, file.data);
            });
            renderButton.disabled = false;
        });


        export async function render() {
            scad.callMain(["bottle-clip.scad", "-o", "clip.stl", "--info"]);
            console.log("render done");
            const output = scad.FS.readFile("/clip.stl");

            window.out_file = new File([output], {
                type: "application/octet-stream"
            });
            downloadButton.disabled = false;
            stl_viewer.add_model({ local_file: out_file });
        };

        export async function upload(file) {
            stl_viewer.add_model({ local_file: file });
            window.preload = file;
        }

        export function download(filename) {
            // Create a new link
            const anchor = document.createElement('a');
            anchor.href = URL.createObjectURL(window.out_file);
            anchor.download = filename;

            // Append to the DOM
            document.body.appendChild(anchor);

            // Trigger `click` event
            anchor.click();

            // Remove element from DOM
            document.body.removeChild(anchor);
        };

        window.stl_viewer = stl_viewer;
        window.upload = upload;
        window.render = render;
        window.download = download;
        window.scad = scad;

    </script>
</body>

</html>